<!DOCTYPE html>
<html lang="kn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ಮನೆಮನೆ ಸಮೀಕ್ಷಾ ಪ್ರಪತ್ರ</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    input, select, textarea { width: 100%; max-width: 400px; margin-top: 5px; }
    button { margin-top: 15px; padding: 8px 16px; }
    .error { color: red; }
    hr { margin: 20px 0; }
  </style>
</head>
<body>

  <h1>ವಿವೇಕಾನಂದ ಗ್ರಾಮೀಣ ವಿದ್ಯಾ ಸಂಸ್ಥೆ</h1>
  <h2>ಭುವನೇಶ್ವರಿ ಆದರ್ಶ ಹಿರಿಯ ಪ್ರಾಥಮಿಕ ಶಾಲೆ, ಕೊಡಿಯಾಲಹೊಸಪೇಟೆ</h2>
  <p>
    ಸರ್ವೇ ದಿನಾಂಕ: <input type="date" id="surveyDate" required>
    <br>
    ಶಿಕ್ಷಕರ ಹೆಸರು: <input type="text" id="teacherName" placeholder="ಶಿಕ್ಷಕರ ಹೆಸರು" required>
  </p>
  <h3>ಮನೆಮನೆ ಸಮೀಕ್ಷಾ ಪ್ರಪತ್ರ (2025–26 ಶೈಕ್ಷಣಿಕ ವರ್ಷ)</h3>
  <h4>"ಕನ್ನಡ ಕಲಿಯೋಣ, ಶಾಲೆಗೆ ಬರುವೋಣ" ಅಭಿಯಾನ</h4>

  <!-- GPS Button (Always visible) -->
  <p>ದಯವಿಟ್ಟು ಕೆಳಗಿನ ಬಟನ್ ಒತ್ತಿ, ನಿಮ್ಮ GPS ವಿವರಗಳನ್ನು ಸ್ವಯಂಚಾಲಿತವಾಗಿ ತುಂಬಿಕೊಳ್ಳಲು:</p>
  <button id="getLocationBtn">GPS ಅನುಮತಿ ನೀಡಿ</button>
  <p id="gpsStatus" class="error"></p>

  <!-- Survey Form (Always Visible) -->
  <form id="surveyForm">
    <hr>
    <h3>ಮನೆಮನೆ ಸಮೀಕ್ಷೆ ವಿವರಗಳು</h3>
    <label for="serialNumber">ಕ್ರಮ ಸಂಖ್ಯೆ:</label>
    <input type="text" id="serialNumber" name="serialNumber" required>
    
    <label for="parentName">ಪೋಷಕರ / ಪಾಲಕರ ಹೆಸರು:</label>
    <input type="text" id="parentName" name="parentName" required>
    
    <label for="childName">ಮಕ್ಕಳ ಹೆಸರು:</label>
    <input type="text" id="childName" name="childName" required>
    
    <label for="age">ವಯಸ್ಸು:</label>
    <input type="number" id="age" name="age" required>
    
    <label for="status">ಈಗ ಏನು ಮಾಡಿದ್ದಾರೆ? (ಹಾಜರಾಗಿದ್ದಾರೆ / ಡ್ರಾಪೌಟ್):</label>
    <select id="status" name="status" required>
      <option value="ಹಾಜರಾಗಿದ್ದಾರೆ">ಹಾಜರಾಗಿದ್ದಾರೆ</option>
      <option value="ಡ್ರಾಪೌಟ್">ಡ್ರಾಪೌಟ್</option>
    </select>
    
    <label for="mobileNumber">ಮೊಬೈಲ್ ಸಂಖ್ಯೆ:</label>
    <input type="tel" id="mobileNumber" name="mobileNumber" required>
    
    <label for="homeAddress">ಗೃಹ ವಿಳಾಸ:</label>
    <textarea id="homeAddress" name="homeAddress" required></textarea>
    
    <label for="notes">ಟಿಪ್ಪಣಿ / ಗಮನಾರ್ಹತೆ:</label>
    <textarea id="notes" name="notes"></textarea>
    
    <label for="homeImage">ಮನೆ ಚಿತ್ರದ ಅಪ್‌ಲೋಡ್:</label>
    <input type="file" id="homeImage" name="homeImage" accept="image/*">
    
    <!-- Hidden fields to store GPS coordinates (these remain hidden, but the form is visible) -->
    <input type="hidden" id="latitude" name="latitude">
    <input type="hidden" id="longitude" name="longitude">
    
    <button type="submit">ಸಮರ್ಪಿಸಿ</button>
  </form>

  <div id="result"></div>

  <!-- Include Supabase JS library from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Replace these with your actual Supabase project details.
    const SUPABASE_URL = 'https://your-supabase-url.supabase.co';
    const SUPABASE_KEY = 'your-public-anon-key';

    // Initialize Supabase client.
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const getLocationBtn = document.getElementById('getLocationBtn');
    const gpsStatus = document.getElementById('gpsStatus');

    // Request GPS permission and fill hidden fields when button is clicked.
    getLocationBtn.addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(success, error);
      } else {
        gpsStatus.textContent = "ಈ ಸಾಧನದಲ್ಲಿ GPS ಸೌಲಭ್ಯ ಲಭ್ಯವಿಲ್ಲ.";
      }
    });

    function success(position) {
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;
      
      // Set the hidden fields with the GPS coordinates.
      document.getElementById('latitude').value = latitude;
      document.getElementById('longitude').value = longitude;
      
      gpsStatus.textContent = "GPS ವಿವರಗಳನ್ನು ಪಡೆದಿದೆ.";
    }

    function error(err) {
      gpsStatus.textContent = "GPS ಅನುಮತಿ ನೀಡಲಾಗಲಿಲ್ಲ. ದಯವಿಟ್ಟು ಸಾಕ್ಷ್ಯಪಡಿಸಿ.";
    }

    // Handle form submission.
    const surveyForm = document.getElementById('surveyForm');
    surveyForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Gather the survey data.
      const surveyData = {
        survey_date: document.getElementById('surveyDate').value,
        teacher_name: document.getElementById('teacherName').value,
        serial_number: document.getElementById('serialNumber').value,
        parent_name: document.getElementById('parentName').value,
        child_name: document.getElementById('childName').value,
        age: parseInt(document.getElementById('age').value),
        status: document.getElementById('status').value,
        mobile_number: document.getElementById('mobileNumber').value,
        home_address: document.getElementById('homeAddress').value,
        notes: document.getElementById('notes').value,
        latitude: document.getElementById('latitude').value,
        longitude: document.getElementById('longitude').value
      };

      // Handle image upload if a file is selected.
      const homeImageFile = document.getElementById('homeImage').files[0];
      if (homeImageFile) {
        // Create a unique filename (using a timestamp).
        const fileName = Date.now() + '_' + homeImageFile.name;
        
        // Upload the image to Supabase Storage (ensure you have created a bucket named 'home-images').
        const { data: storageData, error: storageError } = await supabase
          .storage
          .from('home-images')
          .upload(fileName, homeImageFile);
        
        if (storageError) {
          document.getElementById('result').textContent = 'ಚಿತ್ರ ಅಪ್‌ಲೋಡ್ ಮಾಡುವಲ್ಲಿ ದೋಷ: ' + storageError.message;
          return;
        }
        
        // Retrieve the public URL of the uploaded image.
        const { publicURL, error: urlError } = supabase
          .storage
          .from('home-images')
          .getPublicUrl(fileName);
        
        if (urlError) {
          document.getElementById('result').textContent = 'ಚಿತ್ರ URL ಪಡೆಯುವಲ್ಲಿ ದೋಷ: ' + urlError.message;
          return;
        }
        surveyData.home_image_url = publicURL;
      }
      
      // Insert the survey data into the Supabase table 'surveys'.
      let { data, error } = await supabase
        .from('surveys')
        .insert([ surveyData ]);
      
      if (error) {
        document.getElementById('result').textContent = 'ಡೇಟಾ ಸಂಗ್ರಹಿಸುವಲ್ಲಿ ದೋಷ: ' + error.message;
      } else {
        document.getElementById('result').textContent = 'ಸಮರ್ಪಣೆ ಯಶಸ್ವಿಯಾಗಿದೆ!';
        surveyForm.reset();
      }
    });
  </script>
</body>
</html>
